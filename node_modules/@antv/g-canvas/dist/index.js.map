{"version":3,"file":"index.js","sources":["../src/Canvas2DContextService.ts","../src/ContextRegisterPlugin.ts","../src/index.ts"],"sourcesContent":["import type {\n  RenderingContext,\n  CanvasContext,\n  CanvasLike,\n  DataURLOptions,\n  GlobalRuntime,\n  CanvasConfig,\n  ContextService,\n} from '@antv/g-lite';\nimport { RenderReason, isBrowser, setDOMSize } from '@antv/g-lite';\nimport { isString } from '@antv/util';\n\nexport class Canvas2DContextService\n  implements ContextService<CanvasRenderingContext2D>\n{\n  private $container: HTMLElement | null;\n  private $canvas: CanvasLike | null;\n  private dpr: number;\n  private context:\n    | CanvasRenderingContext2D\n    | OffscreenCanvasRenderingContext2D\n    | null;\n  private canvasConfig: Partial<CanvasConfig>;\n  private renderingContext: RenderingContext;\n\n  constructor(context: GlobalRuntime & CanvasContext) {\n    this.renderingContext = context.renderingContext;\n    this.canvasConfig = context.config;\n  }\n\n  init() {\n    const { container, canvas } = this.canvasConfig;\n\n    if (canvas) {\n      this.$canvas = canvas;\n\n      if (\n        container &&\n        (canvas as HTMLCanvasElement).parentElement !== container\n      ) {\n        (container as HTMLElement).appendChild(canvas as HTMLCanvasElement);\n      }\n\n      this.$container = (canvas as HTMLCanvasElement).parentElement;\n      this.canvasConfig.container = this.$container;\n    } else if (container) {\n      // create container\n      this.$container = isString(container)\n        ? document.getElementById(container)\n        : container;\n      if (this.$container) {\n        // create canvas\n        const $canvas = document.createElement('canvas');\n\n        this.$container.appendChild($canvas);\n        if (!this.$container.style.position) {\n          this.$container.style.position = 'relative';\n        }\n        this.$canvas = $canvas;\n      }\n    }\n\n    this.context = this.$canvas.getContext('2d');\n    this.resize(this.canvasConfig.width, this.canvasConfig.height);\n  }\n\n  getContext() {\n    return this.context as CanvasRenderingContext2D;\n  }\n\n  getDomElement() {\n    return this.$canvas;\n  }\n\n  getDPR() {\n    return this.dpr;\n  }\n\n  getBoundingClientRect() {\n    if ((this.$canvas as HTMLCanvasElement).getBoundingClientRect) {\n      return (this.$canvas as HTMLCanvasElement).getBoundingClientRect();\n    }\n  }\n\n  destroy() {\n    // @ts-ignore\n    if (this.$container && this.$canvas && this.$canvas.parentNode) {\n      // destroy context\n      // @ts-ignore\n      this.$container.removeChild(this.$canvas);\n    }\n  }\n\n  resize(width: number, height: number) {\n    const { devicePixelRatio } = this.canvasConfig;\n\n    // use user-defined dpr first\n    let dpr = devicePixelRatio || (isBrowser && window.devicePixelRatio) || 1;\n    dpr = dpr >= 1 ? Math.ceil(dpr) : 1;\n    this.dpr = dpr;\n\n    if (this.$canvas) {\n      // set canvas width & height\n      this.$canvas.width = this.dpr * width;\n      this.$canvas.height = this.dpr * height;\n\n      // set CSS style width & height\n      setDOMSize(this.$canvas, width, height);\n\n      // const dpr = this.getDPR();\n      // scale all drawing operations by the dpr\n      // @see https://www.html5rocks.com/en/tutorials/canvas/hidpi/\n      // this.context.scale(dpr, dpr);\n    }\n\n    this.renderingContext.renderReasons.add(RenderReason.CAMERA_CHANGED);\n  }\n\n  applyCursorStyle(cursor: string) {\n    if (this.$container && this.$container.style) {\n      this.$container.style.cursor = cursor;\n    }\n  }\n\n  async toDataURL(options: Partial<DataURLOptions> = {}) {\n    const { type, encoderOptions } = options;\n    return (this.context.canvas as HTMLCanvasElement).toDataURL(\n      type,\n      encoderOptions,\n    );\n  }\n}\n","import { AbstractRendererPlugin } from '@antv/g-lite';\nimport { Canvas2DContextService } from './Canvas2DContextService';\n\nexport class ContextRegisterPlugin extends AbstractRendererPlugin {\n  name = 'canvas-context-register';\n  init(): void {\n    this.context.ContextService = Canvas2DContextService;\n  }\n  destroy(): void {\n    delete this.context.ContextService;\n  }\n}\n","import type { RendererConfig } from '@antv/g-lite';\nimport { AbstractRenderer } from '@antv/g-lite';\nimport * as CanvasPathGenerator from '@antv/g-plugin-canvas-path-generator';\nimport * as CanvasPicker from '@antv/g-plugin-canvas-picker';\nimport * as CanvasRenderer from '@antv/g-plugin-canvas-renderer';\nimport * as DomInteraction from '@antv/g-plugin-dom-interaction';\nimport * as HTMLRenderer from '@antv/g-plugin-html-renderer';\nimport * as ImageLoader from '@antv/g-plugin-image-loader';\nimport { ContextRegisterPlugin } from './ContextRegisterPlugin';\n\nexport {\n  CanvasPathGenerator,\n  CanvasPicker,\n  CanvasRenderer,\n  DomInteraction,\n  HTMLRenderer,\n  ImageLoader,\n};\n\nexport class Renderer extends AbstractRenderer {\n  constructor(config?: Partial<RendererConfig>) {\n    super(config);\n\n    // register Canvas2DContext\n    this.registerPlugin(new ContextRegisterPlugin());\n    this.registerPlugin(new ImageLoader.Plugin());\n    this.registerPlugin(new CanvasPathGenerator.Plugin());\n    // enable rendering with Canvas2D API\n    this.registerPlugin(new CanvasRenderer.Plugin());\n    this.registerPlugin(new DomInteraction.Plugin());\n    // enable picking with Canvas2D API\n    this.registerPlugin(new CanvasPicker.Plugin());\n\n    // render HTML component\n    this.registerPlugin(new HTMLRenderer.Plugin());\n  }\n}\n"],"names":["Canvas2DContextService","context","_classCallCheck","renderingContext","canvasConfig","config","_createClass","key","value","init","_this$canvasConfig","container","canvas","$canvas","parentElement","appendChild","$container","isString","document","getElementById","createElement","style","position","getContext","resize","width","height","getDomElement","getDPR","dpr","getBoundingClientRect","destroy","parentNode","removeChild","devicePixelRatio","isBrowser","window","Math","ceil","setDOMSize","renderReasons","add","RenderReason","CAMERA_CHANGED","applyCursorStyle","cursor","_toDataURL","_asyncToGenerator","_regeneratorRuntime","mark","_callee","options","type","encoderOptions","_args","arguments","wrap","_callee$","_context","prev","next","length","undefined","abrupt","toDataURL","stop","apply","ContextRegisterPlugin","_AbstractRendererPlug","_this","_len","args","Array","_key","_callSuper","concat","name","_inherits","ContextService","AbstractRendererPlugin","Renderer","_AbstractRenderer","registerPlugin","ImageLoader","Plugin","CanvasPathGenerator","CanvasRenderer","DomInteraction","CanvasPicker","HTMLRenderer","AbstractRenderer"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAYA,IAAaA,sBAAsB,gBAAA,YAAA;EAajC,SAAAA,sBAAAA,CAAYC,OAAsC,EAAE;AAAAC,IAAAA,eAAA,OAAAF,sBAAA,CAAA,CAAA;AAClD,IAAA,IAAI,CAACG,gBAAgB,GAAGF,OAAO,CAACE,gBAAgB,CAAA;AAChD,IAAA,IAAI,CAACC,YAAY,GAAGH,OAAO,CAACI,MAAM,CAAA;AACpC,GAAA;EAAC,OAAAC,YAAA,CAAAN,sBAAA,EAAA,CAAA;IAAAO,GAAA,EAAA,MAAA;AAAAC,IAAAA,KAAA,EAED,SAAAC,IAAIA,GAAG;AACL,MAAA,IAAAC,kBAAA,GAA8B,IAAI,CAACN,YAAY;QAAvCO,SAAS,GAAAD,kBAAA,CAATC,SAAS;QAAEC,MAAM,GAAAF,kBAAA,CAANE,MAAM,CAAA;AAEzB,MAAA,IAAIA,MAAM,EAAE;QACV,IAAI,CAACC,OAAO,GAAGD,MAAM,CAAA;AAErB,QAAA,IACED,SAAS,IACRC,MAAM,CAAuBE,aAAa,KAAKH,SAAS,EACzD;AACCA,UAAAA,SAAS,CAAiBI,WAAW,CAACH,MAA2B,CAAC,CAAA;AACrE,SAAA;AAEA,QAAA,IAAI,CAACI,UAAU,GAAIJ,MAAM,CAAuBE,aAAa,CAAA;AAC7D,QAAA,IAAI,CAACV,YAAY,CAACO,SAAS,GAAG,IAAI,CAACK,UAAU,CAAA;OAC9C,MAAM,IAAIL,SAAS,EAAE;AACpB;AACA,QAAA,IAAI,CAACK,UAAU,GAAGC,aAAQ,CAACN,SAAS,CAAC,GACjCO,QAAQ,CAACC,cAAc,CAACR,SAAS,CAAC,GAClCA,SAAS,CAAA;QACb,IAAI,IAAI,CAACK,UAAU,EAAE;AACnB;AACA,UAAA,IAAMH,OAAO,GAAGK,QAAQ,CAACE,aAAa,CAAC,QAAQ,CAAC,CAAA;AAEhD,UAAA,IAAI,CAACJ,UAAU,CAACD,WAAW,CAACF,OAAO,CAAC,CAAA;UACpC,IAAI,CAAC,IAAI,CAACG,UAAU,CAACK,KAAK,CAACC,QAAQ,EAAE;AACnC,YAAA,IAAI,CAACN,UAAU,CAACK,KAAK,CAACC,QAAQ,GAAG,UAAU,CAAA;AAC7C,WAAA;UACA,IAAI,CAACT,OAAO,GAAGA,OAAO,CAAA;AACxB,SAAA;AACF,OAAA;MAEA,IAAI,CAACZ,OAAO,GAAG,IAAI,CAACY,OAAO,CAACU,UAAU,CAAC,IAAI,CAAC,CAAA;AAC5C,MAAA,IAAI,CAACC,MAAM,CAAC,IAAI,CAACpB,YAAY,CAACqB,KAAK,EAAE,IAAI,CAACrB,YAAY,CAACsB,MAAM,CAAC,CAAA;AAChE,KAAA;AAAC,GAAA,EAAA;IAAAnB,GAAA,EAAA,YAAA;AAAAC,IAAAA,KAAA,EAED,SAAAe,UAAUA,GAAG;MACX,OAAO,IAAI,CAACtB,OAAO,CAAA;AACrB,KAAA;AAAC,GAAA,EAAA;IAAAM,GAAA,EAAA,eAAA;AAAAC,IAAAA,KAAA,EAED,SAAAmB,aAAaA,GAAG;MACd,OAAO,IAAI,CAACd,OAAO,CAAA;AACrB,KAAA;AAAC,GAAA,EAAA;IAAAN,GAAA,EAAA,QAAA;AAAAC,IAAAA,KAAA,EAED,SAAAoB,MAAMA,GAAG;MACP,OAAO,IAAI,CAACC,GAAG,CAAA;AACjB,KAAA;AAAC,GAAA,EAAA;IAAAtB,GAAA,EAAA,uBAAA;AAAAC,IAAAA,KAAA,EAED,SAAAsB,qBAAqBA,GAAG;AACtB,MAAA,IAAK,IAAI,CAACjB,OAAO,CAAuBiB,qBAAqB,EAAE;AAC7D,QAAA,OAAQ,IAAI,CAACjB,OAAO,CAAuBiB,qBAAqB,EAAE,CAAA;AACpE,OAAA;AACF,KAAA;AAAC,GAAA,EAAA;IAAAvB,GAAA,EAAA,SAAA;AAAAC,IAAAA,KAAA,EAED,SAAAuB,OAAOA,GAAG;AACR;AACA,MAAA,IAAI,IAAI,CAACf,UAAU,IAAI,IAAI,CAACH,OAAO,IAAI,IAAI,CAACA,OAAO,CAACmB,UAAU,EAAE;AAC9D;AACA;QACA,IAAI,CAAChB,UAAU,CAACiB,WAAW,CAAC,IAAI,CAACpB,OAAO,CAAC,CAAA;AAC3C,OAAA;AACF,KAAA;AAAC,GAAA,EAAA;IAAAN,GAAA,EAAA,QAAA;AAAAC,IAAAA,KAAA,EAED,SAAAgB,MAAMA,CAACC,KAAa,EAAEC,MAAc,EAAE;AACpC,MAAA,IAAQQ,gBAAgB,GAAK,IAAI,CAAC9B,YAAY,CAAtC8B,gBAAgB,CAAA;;AAExB;MACA,IAAIL,GAAG,GAAGK,gBAAgB,IAAKC,eAAS,IAAIC,MAAM,CAACF,gBAAiB,IAAI,CAAC,CAAA;AACzEL,MAAAA,GAAG,GAAGA,GAAG,IAAI,CAAC,GAAGQ,IAAI,CAACC,IAAI,CAACT,GAAG,CAAC,GAAG,CAAC,CAAA;MACnC,IAAI,CAACA,GAAG,GAAGA,GAAG,CAAA;MAEd,IAAI,IAAI,CAAChB,OAAO,EAAE;AAChB;QACA,IAAI,CAACA,OAAO,CAACY,KAAK,GAAG,IAAI,CAACI,GAAG,GAAGJ,KAAK,CAAA;QACrC,IAAI,CAACZ,OAAO,CAACa,MAAM,GAAG,IAAI,CAACG,GAAG,GAAGH,MAAM,CAAA;;AAEvC;QACAa,gBAAU,CAAC,IAAI,CAAC1B,OAAO,EAAEY,KAAK,EAAEC,MAAM,CAAC,CAAA;;AAEvC;AACA;AACA;AACA;AACF,OAAA;MAEA,IAAI,CAACvB,gBAAgB,CAACqC,aAAa,CAACC,GAAG,CAACC,kBAAY,CAACC,cAAc,CAAC,CAAA;AACtE,KAAA;AAAC,GAAA,EAAA;IAAApC,GAAA,EAAA,kBAAA;AAAAC,IAAAA,KAAA,EAED,SAAAoC,gBAAgBA,CAACC,MAAc,EAAE;MAC/B,IAAI,IAAI,CAAC7B,UAAU,IAAI,IAAI,CAACA,UAAU,CAACK,KAAK,EAAE;AAC5C,QAAA,IAAI,CAACL,UAAU,CAACK,KAAK,CAACwB,MAAM,GAAGA,MAAM,CAAA;AACvC,OAAA;AACF,KAAA;AAAC,GAAA,EAAA;IAAAtC,GAAA,EAAA,WAAA;IAAAC,KAAA,EAAA,YAAA;MAAA,IAAAsC,UAAA,GAAAC,iBAAA,cAAAC,mBAAA,EAAAC,CAAAA,IAAA,CAED,SAAAC,OAAA,GAAA;AAAA,QAAA,IAAAC,OAAA;UAAAC,IAAA;UAAAC,cAAA;AAAAC,UAAAA,KAAA,GAAAC,SAAA,CAAA;AAAA,QAAA,OAAAP,mBAAA,EAAA,CAAAQ,IAAA,CAAA,SAAAC,SAAAC,QAAA,EAAA;AAAA,UAAA,OAAA,CAAA,EAAA,QAAAA,QAAA,CAAAC,IAAA,GAAAD,QAAA,CAAAE,IAAA;AAAA,YAAA,KAAA,CAAA;AAAgBT,cAAAA,OAAgC,GAAAG,KAAA,CAAAO,MAAA,GAAAP,CAAAA,IAAAA,KAAA,CAAAQ,CAAAA,CAAAA,KAAAA,SAAA,GAAAR,KAAA,CAAG,CAAA,CAAA,GAAA,EAAE,CAAA;cAC3CF,IAAI,GAAqBD,OAAO,CAAhCC,IAAI,EAAEC,cAAc,GAAKF,OAAO,CAA1BE,cAAc,CAAA;AAAA,cAAA,OAAAK,QAAA,CAAAK,MAAA,CAAA,QAAA,EACpB,IAAI,CAAC9D,OAAO,CAACW,MAAM,CAAuBoD,SAAS,CACzDZ,IAAI,EACJC,cACF,CAAC,CAAA,CAAA;AAAA,YAAA,KAAA,CAAA,CAAA;AAAA,YAAA,KAAA,KAAA;cAAA,OAAAK,QAAA,CAAAO,IAAA,EAAA,CAAA;AAAA,WAAA;AAAA,SAAA,EAAAf,OAAA,EAAA,IAAA,CAAA,CAAA;OACF,CAAA,CAAA,CAAA;AAAA,MAAA,SANKc,SAASA,GAAA;AAAA,QAAA,OAAAlB,UAAA,CAAAoB,KAAA,CAAA,IAAA,EAAAX,SAAA,CAAA,CAAA;AAAA,OAAA;AAAA,MAAA,OAATS,SAAS,CAAA;AAAA,KAAA,EAAA;AAAA,GAAA,CAAA,CAAA,CAAA;AAAA,CAAA,EAAA;;ACzHJG,IAAAA,qBAAqB,0BAAAC,qBAAA,EAAA;AAAA,EAAA,SAAAD,qBAAA,GAAA;AAAA,IAAA,IAAAE,KAAA,CAAA;AAAAnE,IAAAA,eAAA,OAAAiE,qBAAA,CAAA,CAAA;AAAA,IAAA,KAAA,IAAAG,IAAA,GAAAf,SAAA,CAAAM,MAAA,EAAAU,IAAA,GAAAC,IAAAA,KAAA,CAAAF,IAAA,GAAAG,IAAA,GAAA,CAAA,EAAAA,IAAA,GAAAH,IAAA,EAAAG,IAAA,EAAA,EAAA;AAAAF,MAAAA,IAAA,CAAAE,IAAA,CAAAlB,GAAAA,SAAA,CAAAkB,IAAA,CAAA,CAAA;AAAA,KAAA;AAAAJ,IAAAA,KAAA,GAAAK,UAAA,CAAA,IAAA,EAAAP,qBAAA,EAAAQ,EAAAA,CAAAA,MAAA,CAAAJ,IAAA,CAAA,CAAA,CAAA;IAAAF,KAAA,CAChCO,IAAI,GAAG,yBAAyB,CAAA;AAAA,IAAA,OAAAP,KAAA,CAAA;AAAA,GAAA;EAAAQ,SAAA,CAAAV,qBAAA,EAAAC,qBAAA,CAAA,CAAA;EAAA,OAAA9D,YAAA,CAAA6D,qBAAA,EAAA,CAAA;IAAA5D,GAAA,EAAA,MAAA;AAAAC,IAAAA,KAAA,EAChC,SAAAC,IAAIA,GAAS;AACX,MAAA,IAAI,CAACR,OAAO,CAAC6E,cAAc,GAAG9E,sBAAsB,CAAA;AACtD,KAAA;AAAC,GAAA,EAAA;IAAAO,GAAA,EAAA,SAAA;AAAAC,IAAAA,KAAA,EACD,SAAAuB,OAAOA,GAAS;AACd,MAAA,OAAO,IAAI,CAAC9B,OAAO,CAAC6E,cAAc,CAAA;AACpC,KAAA;AAAC,GAAA,CAAA,CAAA,CAAA;AAAA,CAAA,CAPwCC,4BAAsB,CAAA;;ACgBpDC,IAAAA,QAAQ,0BAAAC,iBAAA,EAAA;EACnB,SAAAD,QAAAA,CAAY3E,MAAgC,EAAE;AAAA,IAAA,IAAAgE,KAAA,CAAA;AAAAnE,IAAAA,eAAA,OAAA8E,QAAA,CAAA,CAAA;AAC5CX,IAAAA,KAAA,GAAAK,UAAA,CAAAM,IAAAA,EAAAA,QAAA,GAAM3E,MAAM,CAAA,CAAA,CAAA;;AAEZ;AACAgE,IAAAA,KAAA,CAAKa,cAAc,CAAC,IAAIf,qBAAqB,EAAE,CAAC,CAAA;IAChDE,KAAA,CAAKa,cAAc,CAAC,IAAIC,sBAAW,CAACC,MAAM,EAAE,CAAC,CAAA;IAC7Cf,KAAA,CAAKa,cAAc,CAAC,IAAIG,8BAAmB,CAACD,MAAM,EAAE,CAAC,CAAA;AACrD;IACAf,KAAA,CAAKa,cAAc,CAAC,IAAII,yBAAc,CAACF,MAAM,EAAE,CAAC,CAAA;IAChDf,KAAA,CAAKa,cAAc,CAAC,IAAIK,yBAAc,CAACH,MAAM,EAAE,CAAC,CAAA;AAChD;IACAf,KAAA,CAAKa,cAAc,CAAC,IAAIM,uBAAY,CAACJ,MAAM,EAAE,CAAC,CAAA;;AAE9C;IACAf,KAAA,CAAKa,cAAc,CAAC,IAAIO,uBAAY,CAACL,MAAM,EAAE,CAAC,CAAA;AAAC,IAAA,OAAAf,KAAA,CAAA;AACjD,GAAA;EAACQ,SAAA,CAAAG,QAAA,EAAAC,iBAAA,CAAA,CAAA;EAAA,OAAA3E,YAAA,CAAA0E,QAAA,CAAA,CAAA;AAAA,CAAA,CAhB2BU,sBAAgB;;;;;;;;;;"}