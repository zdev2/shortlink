/*!
 * @antv/g-plugin-canvas-renderer
 * @description A G plugin of renderer implementation with Canvas2D API
 * @version 2.1.2
 * @date 10/23/2024, 11:15:42 AM
 * @author AntVis
 * @docs https://g.antv.antgroup.com/
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@antv/g-lite"),require("@antv/g-plugin-image-loader")):"function"==typeof define&&define.amd?define(["exports","@antv/g-lite","@antv/g-plugin-image-loader"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).G=e.G||{},e.G.CanvasRenderer={}),e.window.G,e.window.G.ImageLoader)}(this,(function(e,t,r){"use strict";function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function i(e){var t=function(e,t){if("object"!=n(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t||"default");if("object"!=n(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==n(t)?t:t+""}function a(e,t,r){return(t=i(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function l(e){for(var t=1;arguments.length>t;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var r=0;t.length>r;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,i(n.key),n)}}function u(e,t,r){return t&&s(e.prototype,t),r&&s(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function d(e){return d=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},d(e)}function h(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(h=function(){return!!e})()}function f(e,t){if(t&&("object"==n(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function p(e,t,r){return t=d(t),f(e,h()?Reflect.construct(t,r||[],d(e).constructor):t.apply(e,r))}function v(e,t){return v=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},v(e,t)}function y(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&v(e,t)}function m(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);t>r;r++)n[r]=e[r];return n}function g(e,t){if(e){if("string"==typeof e)return m(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?m(e,t):void 0}}function b(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,i,a,o,l=[],c=!0,s=!1;try{if(a=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;c=!1}else for(;!(c=(n=a.call(r)).done)&&(l.push(n.value),l.length!==t);c=!0);}catch(e){s=!0,i=e}finally{try{if(!c&&null!=r.return&&(o=r.return(),Object(o)!==o))return}finally{if(s)throw i}}return l}}(e,t)||g(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(e){return function(e){if(Array.isArray(e))return m(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||g(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var S=function(e){return null==e},M="undefined"!=typeof Float32Array?Float32Array:Array;function A(){var e=new M(16);return M!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function x(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function O(e,t,r){var n=t[0],i=t[1],a=t[2],o=t[3],l=t[4],c=t[5],s=t[6],u=t[7],d=t[8],h=t[9],f=t[10],p=t[11],v=t[12],y=t[13],m=t[14],g=t[15],b=r[0],w=r[1],S=r[2],M=r[3];return e[0]=b*n+w*l+S*d+M*v,e[1]=b*i+w*c+S*h+M*y,e[2]=b*a+w*s+S*f+M*m,e[3]=b*o+w*u+S*p+M*g,e[4]=(b=r[4])*n+(w=r[5])*l+(S=r[6])*d+(M=r[7])*v,e[5]=b*i+w*c+S*h+M*y,e[6]=b*a+w*s+S*f+M*m,e[7]=b*o+w*u+S*p+M*g,e[8]=(b=r[8])*n+(w=r[9])*l+(S=r[10])*d+(M=r[11])*v,e[9]=b*i+w*c+S*h+M*y,e[10]=b*a+w*s+S*f+M*m,e[11]=b*o+w*u+S*p+M*g,e[12]=(b=r[12])*n+(w=r[13])*l+(S=r[14])*d+(M=r[15])*v,e[13]=b*i+w*c+S*h+M*y,e[14]=b*a+w*s+S*f+M*m,e[15]=b*o+w*u+S*p+M*g,e}function R(){var e=new M(3);return M!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function P(e,t,r){var n=t[0],i=t[1],a=t[2],o=r[3]*n+r[7]*i+r[11]*a+r[15];return e[0]=(r[0]*n+r[4]*i+r[8]*a+r[12])/(o=o||1),e[1]=(r[1]*n+r[5]*i+r[9]*a+r[13])/o,e[2]=(r[2]*n+r[6]*i+r[10]*a+r[14])/o,e}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)}),R();var B=function(){function e(t){c(this,e),this.removedRBushNodeAABBs=[],this.renderQueue=[],this.restoreStack=[],this.clearFullScreenLastFrame=!1,this.clearFullScreen=!1,this.vpMatrix=A(),this.dprMatrix=A(),this.tmpMat4=A(),this.vec3a=R(),this.vec3b=R(),this.vec3c=R(),this.vec3d=R(),this.canvasRendererPluginOptions=t}return u(e,[{key:"apply",value:function(r,n){var i=this;this.context=r;var a=r.config,o=r.camera,l=r.renderingService,c=r.renderingContext,s=r.pathGeneratorFactory;this.rBush=r.rBushRoot,this.pathGeneratorFactory=s;var u=r.contextService,d=c.root.ownerDocument.defaultView,h=function(e){var t=e.target.rBushNode;t.aabb&&i.removedRBushNodeAABBs.push(t.aabb)},f=function(e){var t=e.target.rBushNode;t.aabb&&i.removedRBushNodeAABBs.push(t.aabb)};l.hooks.init.tap(e.tag,(function(){d.addEventListener(t.ElementEvent.UNMOUNTED,h),d.addEventListener(t.ElementEvent.CULLED,f);var e=u.getDPR(),r=a.width,n=a.height,o=u.getContext();i.clearRect(o,0,0,r*e,n*e,a.background)})),l.hooks.destroy.tap(e.tag,(function(){d.removeEventListener(t.ElementEvent.UNMOUNTED,h),d.removeEventListener(t.ElementEvent.CULLED,f),i.renderQueue=[],i.removedRBushNodeAABBs=[],i.restoreStack=[]})),l.hooks.beginFrame.tap(e.tag,(function(){var e,t=u.getContext(),r=u.getDPR(),n=a.width,o=a.height,c=i.canvasRendererPluginOptions,s=c.dirtyObjectNumThreshold,h=c.dirtyObjectRatioThreshold,f=l.getStats(),p=f.rendered,v=p/f.total;i.clearFullScreen=i.clearFullScreenLastFrame||!(null!==(e=d.context.renderingPlugins[1])&&void 0!==e&&e.isFirstTimeRenderingFinished)||l.disableDirtyRectangleRendering()||p>s&&v>h,t&&(t.resetTransform?t.resetTransform():t.setTransform(1,0,0,1,0,0),i.clearFullScreen&&i.clearRect(t,0,0,n*r,o*r,a.background))}));var p=function(e,t){e.isVisible()&&!e.isCulled()&&i.renderDisplayObject(e,t,i.context,i.restoreStack,n),(e.sortable.sorted||e.childNodes).forEach((function(e){p(e,t)}))};l.hooks.endFrame.tap(e.tag,(function(){if(0!==c.root.childNodes.length){i.clearFullScreenLastFrame=!1;var e,r,l=u.getContext(),s=u.getDPR();if((e=i.dprMatrix)[0]=(r=[s,s,1])[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=r[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,O(i.vpMatrix,i.dprMatrix,o.getOrthoMatrix()),i.clearFullScreen)p(c.root,l);else{var h=i.safeMergeAABB.apply(i,[i.mergeDirtyAABBs(i.renderQueue)].concat(w(i.removedRBushNodeAABBs.map((function(e){var r=e.minX,n=e.minY,i=e.maxX,a=e.maxY,o=new t.AABB;return o.setMinMax([r,n,0],[i,a,0]),o})))));if(i.removedRBushNodeAABBs=[],t.AABB.isEmpty(h))return void(i.renderQueue=[]);var f=i.convertAABB2Rect(h),v=f.x,y=f.y,m=f.width,g=f.height,b=P(i.vec3a,[v,y,0],i.vpMatrix),S=P(i.vec3b,[v+m,y,0],i.vpMatrix),M=P(i.vec3c,[v,y+g,0],i.vpMatrix),A=P(i.vec3d,[v+m,y+g,0],i.vpMatrix),x=Math.min(b[0],S[0],A[0],M[0]),R=Math.min(b[1],S[1],A[1],M[1]),B=Math.max(b[0],S[0],A[0],M[0]),E=Math.max(b[1],S[1],A[1],M[1]),T=Math.floor(x),k=Math.floor(R),C=Math.ceil(B-x),j=Math.ceil(E-R);l.save(),i.clearRect(l,T,k,C,j,a.background),l.beginPath(),l.rect(T,k,C,j),l.clip(),l.setTransform(i.vpMatrix[0],i.vpMatrix[1],i.vpMatrix[4],i.vpMatrix[5],i.vpMatrix[12],i.vpMatrix[13]),a.renderer.getConfig().enableDirtyRectangleRenderingDebug&&d.dispatchEvent(new t.CustomEvent(t.CanvasEvent.DIRTY_RECTANGLE,{dirtyRect:{x:T,y:k,width:C,height:j}})),i.searchDirtyObjects(h).sort((function(e,t){return e.sortable.renderOrder-t.sortable.renderOrder})).forEach((function(e){e&&e.isVisible()&&!e.isCulled()&&i.renderDisplayObject(e,l,i.context,i.restoreStack,n)})),l.restore(),i.renderQueue.forEach((function(e){i.saveDirtyAABB(e)})),i.renderQueue=[]}i.restoreStack.forEach((function(){l.restore()})),i.restoreStack=[]}else i.clearFullScreenLastFrame=!0})),l.hooks.render.tap(e.tag,(function(e){i.clearFullScreen||i.renderQueue.push(e)}))}},{key:"clearRect",value:function(e,t,r,n,i,a){e.clearRect(t,r,n,i),a&&(e.fillStyle=a,e.fillRect(t,r,n,i))}},{key:"renderDisplayObject",value:function(e,r,n,i,a){var o=e.nodeName,l=i[i.length-1];!l||e.compareDocumentPosition(l)&t.Node.DOCUMENT_POSITION_CONTAINS||(r.restore(),i.pop());var c=this.context.styleRendererFactory[o],s=this.pathGeneratorFactory[o],u=e.parsedStyle.clipPath;if(u){this.applyWorldTransform(r,u);var d=this.pathGeneratorFactory[u.nodeName];d&&(r.save(),i.push(e),r.beginPath(),d(r,u.parsedStyle),r.closePath(),r.clip())}c&&(this.applyWorldTransform(r,e),r.save(),this.applyAttributesToContext(r,e)),s&&(r.beginPath(),s(r,e.parsedStyle),e.nodeName!==t.Shape.LINE&&e.nodeName!==t.Shape.PATH&&e.nodeName!==t.Shape.POLYLINE&&r.closePath()),c&&(c.render(r,e.parsedStyle,e,n,this,a),r.restore()),e.renderable.dirty=!1}},{key:"convertAABB2Rect",value:function(e){var t=e.getMin(),r=e.getMax(),n=Math.floor(t[0]),i=Math.floor(t[1]);return{x:n,y:i,width:Math.ceil(r[0])-n,height:Math.ceil(r[1])-i}}},{key:"mergeDirtyAABBs",value:function(e){var r=new t.AABB;return e.forEach((function(e){var t=e.getRenderBounds();r.add(t);var n=e.renderable.dirtyRenderBounds;n&&r.add(n)})),r}},{key:"searchDirtyObjects",value:function(e){var t=b(e.getMin(),2),r=t[0],n=t[1],i=b(e.getMax(),2);return this.rBush.search({minX:r,minY:n,maxX:i[0],maxY:i[1]}).map((function(e){return e.displayObject}))}},{key:"saveDirtyAABB",value:function(e){var r=e.renderable;r.dirtyRenderBounds||(r.dirtyRenderBounds=new t.AABB);var n=e.getRenderBounds();n&&r.dirtyRenderBounds.update(n.center,n.halfExtents)}},{key:"applyAttributesToContext",value:function(e,t){var r=t.parsedStyle,n=r.stroke,i=r.fill,a=r.opacity,o=r.lineDash,l=r.lineDashOffset;o&&e.setLineDash(o),S(l)||(e.lineDashOffset=l),S(a)||(e.globalAlpha*=a),S(n)||Array.isArray(n)||n.isNone||(e.strokeStyle=t.attributes.stroke),S(i)||Array.isArray(i)||i.isNone||(e.fillStyle=t.attributes.fill)}},{key:"applyWorldTransform",value:function(e,t,r){r?(x(this.tmpMat4,t.getLocalTransform()),O(this.tmpMat4,r,this.tmpMat4),O(this.tmpMat4,this.vpMatrix,this.tmpMat4)):(x(this.tmpMat4,t.getWorldTransform()),O(this.tmpMat4,this.vpMatrix,this.tmpMat4)),e.setTransform(this.tmpMat4[0],this.tmpMat4[1],this.tmpMat4[4],this.tmpMat4[5],this.tmpMat4[12],this.tmpMat4[13])}},{key:"safeMergeAABB",value:function(){for(var e=new t.AABB,r=arguments.length,n=Array(r),i=0;r>i;i++)n[i]=arguments[i];return n.forEach((function(t){e.add(t)})),e}}])}();B.tag="CanvasRenderer";var E=function(){return u((function e(t){c(this,e),this.imagePool=t}),[{key:"render",value:function(e,r,n,i,a,o){var l=r.fill,c=r.fillRule,s=r.opacity,u=void 0===s?1:s,d=r.fillOpacity,h=void 0===d?1:d,f=r.stroke,p=r.strokeOpacity,v=void 0===p?1:p,y=r.lineWidth,m=void 0===y?1:y,g=r.lineCap,b=r.lineJoin,w=r.shadowType,M=r.shadowBlur,A=r.filter,x=r.miterLimit,O=l&&!l.isNone,R=f&&!f.isNone&&m>0,P=0===(null==l?void 0:l.alpha),B=!(!A||!A.length),E=!S(r.shadowColor)&&M>0,k=n.nodeName,C="inner"===w,D=R&&E&&(k===t.Shape.PATH||k===t.Shape.LINE||k===t.Shape.POLYLINE||P||C);O&&(e.globalAlpha=u*h,D||T(n,e,E),j(e,n,l,c,i,a,o,this.imagePool),D||this.clearShadowAndFilter(e,B,E)),R&&(e.globalAlpha=u*v,e.lineWidth=m,S(x)||(e.miterLimit=x),S(g)||(e.lineCap=g),S(b)||(e.lineJoin=b),D&&(C&&(e.globalCompositeOperation="source-atop"),T(n,e,!0),C&&(N(e,n,f,i,a,o,this.imagePool),e.globalCompositeOperation="source-over",this.clearShadowAndFilter(e,B,!0))),N(e,n,f,i,a,o,this.imagePool))}},{key:"clearShadowAndFilter",value:function(e,t,r){if(r&&(e.shadowColor="transparent",e.shadowBlur=0),t){var n=e.filter;!S(n)&&n.indexOf("drop-shadow")>-1&&(e.filter=n.replace(/drop-shadow\([^)]*\)/,"").trim()||"none")}}}])}();function T(e,t,r){var n=e.parsedStyle,i=n.filter,a=n.shadowColor,o=n.shadowBlur,l=n.shadowOffsetX,c=n.shadowOffsetY;i&&i.length&&(t.filter=e.style.filter),r&&(t.shadowColor=""+a,t.shadowBlur=o||0,t.shadowOffsetX=l||0,t.shadowOffsetY=c||0)}function k(e,t,r,n,i,a,o){var l,c;if("rect"===e.image.nodeName){var s=e.image.parsedStyle,u=s.width,d=s.height;c=n.contextService.getDPR();var h=n.config.offscreenCanvas;(l=a.offscreenCanvasCreator.getOrCreateCanvas(h)).width=u*c,l.height=d*c;var f=a.offscreenCanvasCreator.getOrCreateContext(h),p=[];e.image.forEach((function(e){i.renderDisplayObject(e,f,n,p,a)})),p.forEach((function(){f.restore()}))}return o.getOrCreatePatternSync(t,e,r,l,c,t.getGeometryBounds().min,(function(){t.renderable.dirty=!0,n.renderingService.dirtify()}))}function C(e,r,n,i){var a;if(e.type===t.GradientType.LinearGradient||e.type===t.GradientType.RadialGradient){var o=r.getGeometryBounds(),c=o&&2*o.halfExtents[0]||1,s=o&&2*o.halfExtents[1]||1,u=o&&o.min||[0,0];a=i.getOrCreateGradient(l(l({type:e.type},e.value),{},{min:u,width:c,height:s}),n)}return a}function j(e,r,n,i,a,o,l,c){var s=arguments.length>8&&void 0!==arguments[8]&&arguments[8];Array.isArray(n)?n.forEach((function(t){e.fillStyle=C(t,r,e,c),s||(i?e.fill(i):e.fill())})):(t.isPattern(n)&&(e.fillStyle=k(n,r,e,a,o,l,c)),s||(i?e.fill(i):e.fill()))}function N(e,r,n,i,a,o,l){var c=arguments.length>7&&void 0!==arguments[7]&&arguments[7];Array.isArray(n)?n.forEach((function(t){e.strokeStyle=C(t,r,e,l),c||e.stroke()})):(t.isPattern(n)&&(e.strokeStyle=k(n,r,e,i,a,o,l)),c||e.stroke())}function D(e,t){if(!{}.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}var L=0;function F(e){return"__private_"+L+++"_"+e}var I=F("renderDownSampled"),G=F("renderTile"),_=function(){function e(t){c(this,e),Object.defineProperty(this,G,{value:U}),Object.defineProperty(this,I,{value:Y}),this.imagePool=t}return u(e,[{key:"render",value:function(t,n,i){var a=n.x,o=void 0===a?0:a,l=n.y,c=void 0===l?0:l,s=n.width,u=n.height,d=n.src,h=n.shadowColor,f=n.shadowBlur,p=this.imagePool.getImageSync(d,i),v=null==p?void 0:p.img,y=s,m=u;if(v){var g,w,A,x,O,B,E,k,C,j,N,L,F,_,Y,U,W,X,Q,V,z,H,J,q,$,K,Z,ee,te,re,ne,ie,ae,oe,le,ce,se,ue;y||(y=v.width),m||(m=v.height),T(i,t,!S(h)&&f>0);try{var de=i.ownerDocument.defaultView.getContextService().getDomElement(),he=de.width,fe=de.height,pe=t.getTransform(),ve=(H=pe.a,J=pe.c,q=0,$=0,K=pe.b,Z=pe.d,ee=0,te=0,re=0,ne=0,ie=1,ae=0,oe=pe.e,le=pe.f,ce=0,se=1,(ue=new M(16))[0]=H,ue[1]=J,ue[2]=q,ue[3]=$,ue[4]=K,ue[5]=Z,ue[6]=ee,ue[7]=te,ue[8]=re,ue[9]=ne,ue[10]=ie,ue[11]=ae,ue[12]=oe,ue[13]=le,ue[14]=ce,ue[15]=se,ue),ye=(U=[o,c,y,m],W=ve,X=P(R(),[U[0],U[1],0],W),Q=P(R(),[U[0]+U[2],U[1],0],W),V=P(R(),[U[0],U[1]+U[3],0],W),z=P(R(),[U[0]+U[2],U[1]+U[3],0],W),[Math.min(X[0],Q[0],V[0],z[0]),Math.min(X[1],Q[1],V[1],z[1]),Math.max(X[0],Q[0],V[0],z[0])-Math.min(X[0],Q[0],V[0],z[0]),Math.max(X[1],Q[1],V[1],z[1])-Math.min(X[1],Q[1],V[1],z[1])]),me=(g=ye,w=b([0,0,he,fe],4),A=w[0],x=w[1],O=w[2],B=w[3],E=b(g,4),C=E[1],j=E[2],N=E[3],L=Math.max(A,k=E[0]),F=Math.max(x,C),_=Math.min(A+O,k+j),Y=Math.min(x+B,C+N),_>L&&Y>F?[L,F,_-L,Y-F]:null);if(!me)return;if(!i.ownerDocument.defaultView.getConfig().enableLargeImageOptimization)return void e.renderFull(t,n,i,{image:v,drawRect:[o,c,y,m]});if((p.downSamplingRate||.5)>ye[2]/p.size[0])return void D(this,I)[I](t,n,i,{src:d,imageCache:p,drawRect:[o,c,y,m]});if(!r.ImagePool.isSupportTile)return void e.renderFull(t,n,i,{image:v,drawRect:[o,c,y,m]});D(this,G)[G](t,n,i,{src:d,imageCache:p,imageRect:ye,drawRect:me})}catch(e){}}}}],[{key:"renderFull",value:function(e,t,r,n){e.drawImage(n.image,Math.floor(n.drawRect[0]),Math.floor(n.drawRect[1]),Math.ceil(n.drawRect[2]),Math.ceil(n.drawRect[3]))}}])}();function Y(e,t,r,n){var i=n.src,a=n.imageCache;a.downSampled?e.drawImage(a.downSampled,Math.floor(n.drawRect[0]),Math.floor(n.drawRect[1]),Math.ceil(n.drawRect[2]),Math.ceil(n.drawRect[3])):this.imagePool.createDownSampledImage(i,r).then((function(e){r.renderable.dirty=!0,r.ownerDocument.defaultView.context.renderingService.dirtify()})).catch((function(){}))}function U(e,t,r,n){var i=n.src,a=n.imageCache,o=n.imageRect,l=n.drawRect,c=a.size,s=e.getTransform(),u=s.a,d=s.b,h=s.c,f=s.d,p=s.e,v=s.f;if(e.resetTransform(),null!=a&&a.gridSize){for(var y=[c[0]/o[2],c[1]/o[3]],m=[a.tileSize[0]/y[0],a.tileSize[1]/y[1]],g=[Math.floor((l[0]-o[0])/m[0]),Math.ceil((l[0]+l[2]-o[0])/m[0])],b=g[0],w=g[1],S=[Math.floor((l[1]-o[1])/m[1]),Math.ceil((l[1]+l[3]-o[1])/m[1])],M=S[1],A=S[0];M>=A;A++)for(var x=b;w>=x;x++){var O=a.tiles[A][x];if(O){var R=[Math.floor(o[0]+O.tileX*m[0]),Math.floor(o[1]+O.tileY*m[1]),Math.ceil(m[0]),Math.ceil(m[1])];e.drawImage(O.data,R[0],R[1],R[2],R[3])}}e.setTransform(u,d,h,f,p,v)}else this.imagePool.createImageTiles(i,[],r).then((function(){r.renderable.dirty=!0,r.ownerDocument.defaultView.context.renderingService.dirtify()})).catch((function(){}))}var W=function(){return u((function e(t){c(this,e),this.imagePool=t}),[{key:"render",value:function(e,t,r,n,i,a){r.getBounds();var o=t.lineWidth,l=void 0===o?1:o,c=t.textAlign,s=void 0===c?"start":c,u=t.textBaseline,d=void 0===u?"alphabetic":u,h=t.lineJoin,f=void 0===h?"miter":h,p=t.miterLimit,v=void 0===p?10:p,y=t.letterSpacing,m=void 0===y?0:y,g=t.stroke,b=t.fill,w=t.fillRule,M=t.fillOpacity,A=void 0===M?1:M,x=t.strokeOpacity,O=void 0===x?1:x,R=t.opacity,P=void 0===R?1:R,B=t.metrics,E=t.x,k=void 0===E?0:E,C=t.y,j=void 0===C?0:C,N=t.dx,D=t.dy,L=t.shadowColor,F=t.shadowBlur,I=B.lines,G=B.height,_=B.lineHeight,Y=B.lineMetrics;e.font=B.font,e.lineWidth=l,e.textAlign="middle"===s?"center":s;var U=d;"alphabetic"===U&&(U="bottom"),e.lineJoin=f,S(v)||(e.miterLimit=v);var W=j;"middle"===d?W+=-G/2-_/2:"bottom"===d||"alphabetic"===d||"ideographic"===d?W+=-G:"top"!==d&&"hanging"!==d||(W+=-_);var X=k+(N||0);W+=D||0,1===I.length&&("bottom"===U?(U="middle",W-=.5*G):"top"===U&&(U="middle",W+=.5*G)),e.textBaseline=U,T(r,e,!S(L)&&F>0);for(var Q=0;I.length>Q;Q++){var V=l/2+X;W+=_,S(g)||g.isNone||!l||this.drawLetterSpacing(e,r,I[Q],Y[Q],s,V,W,m,b,w,A,g,O,P,!0,n,i,a),S(b)||this.drawLetterSpacing(e,r,I[Q],Y[Q],s,V,W,m,b,w,A,g,O,P,!1,n,i,a)}}},{key:"drawLetterSpacing",value:function(e,t,r,n,i,a,o,l,c,s,u,d,h,f,p,v,y,m){if(0!==l){var g=e.textAlign;e.textAlign="left";var b=a;"center"===i||"middle"===i?b=a-n.width/2:"right"!==i&&"end"!==i||(b=a-n.width);for(var w=Array.from(r),S=e.measureText(r).width,M=0,A=0;w.length>A;++A){var x=w[A];p?this.strokeText(e,t,x,b,o,d,h,v,y,m):this.fillText(e,t,x,b,o,c,s,u,f,v,y,m),b+=S-(M=e.measureText(r.substring(A+1)).width)+l,S=M}e.textAlign=g}else p?this.strokeText(e,t,r,a,o,d,h,v,y,m):this.fillText(e,t,r,a,o,c,s,u,f,v,y,m)}},{key:"fillText",value:function(e,t,r,n,i,a,o,l,c,s,u,d){var h;j(e,t,a,o,s,u,d,this.imagePool,!0);var f=!S(l)&&1!==l;f&&(h=e.globalAlpha,e.globalAlpha=l*c),e.fillText(r,n,i),f&&(e.globalAlpha=h)}},{key:"strokeText",value:function(e,t,r,n,i,a,o,l,c,s){var u;N(e,t,a,l,c,s,this.imagePool,!0);var d=!S(o)&&1!==o;d&&(u=e.globalAlpha,e.globalAlpha=o),e.strokeText(r,n,i),d&&(e.globalAlpha=u)}}])}(),X=function(e){function t(){return c(this,t),p(this,t,arguments)}return y(t,e),u(t)}(E),Q=function(e){function t(){return c(this,t),p(this,t,arguments)}return y(t,e),u(t)}(E),V=function(e){function t(){return c(this,t),p(this,t,arguments)}return y(t,e),u(t)}(E),z=function(e){function t(){return c(this,t),p(this,t,arguments)}return y(t,e),u(t)}(E),H=function(e){function t(){return c(this,t),p(this,t,arguments)}return y(t,e),u(t)}(E),J=function(e){function t(){return c(this,t),p(this,t,arguments)}return y(t,e),u(t)}(E),q=function(e){function t(){return c(this,t),p(this,t,arguments)}return y(t,e),u(t)}(E),$=function(e){function r(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return c(this,r),(e=p(this,r)).name="canvas-renderer",e.options=t,e}return y(r,e),u(r,[{key:"init",value:function(){var e,r=l({dirtyObjectNumThreshold:500,dirtyObjectRatioThreshold:.8},this.options),n=this.context.imagePool,i=new E(n),o=(a(a(a(a(a(a(a(a(a(a(e={},t.Shape.CIRCLE,i),t.Shape.ELLIPSE,i),t.Shape.RECT,i),t.Shape.IMAGE,new _(n)),t.Shape.TEXT,new W(n)),t.Shape.LINE,i),t.Shape.POLYLINE,i),t.Shape.POLYGON,i),t.Shape.PATH,i),t.Shape.GROUP,void 0),a(a(e,t.Shape.HTML,void 0),t.Shape.MESH,void 0));this.context.defaultStyleRendererFactory=o,this.context.styleRendererFactory=o,this.addRenderingPlugin(new B(r))}},{key:"destroy",value:function(){this.removeAllRenderingPlugins(),delete this.context.defaultStyleRendererFactory,delete this.context.styleRendererFactory}}])}(t.AbstractRendererPlugin);e.CircleRenderer=Q,e.EllipseRenderer=V,e.ImageRenderer=_,e.LineRenderer=z,e.PathRenderer=q,e.Plugin=$,e.PolygonRenderer=J,e.PolylineRenderer=H,e.RectRenderer=X,e.TextRenderer=W}));
//# sourceMappingURL=index.umd.min.js.map
